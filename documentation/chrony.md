# Configurer le démon chrony dans OKD

La configuration de chrony dans OKD va se passer par le biais des
fichiers ignitions qui sont préchargés on démarrage des nodes du
cluster. Ignition est tout droit issu de la suite FCOS.

Ce qui va induire un remdémarrage pour chacune des nodes dont les
workers et masters. Il faut donc avant toutes choses veiller à avoir les
ressources suffisantes pour faire tenir l'ensemble des containers sur
n-1 worker (-1 car 1 worker à la fois se fait redémarrer).

Pour se faire, nous allons passer par Butane qui est un binaire qui nous
permet de traduire un premier fichier de conf en Objet MachineConfig et
de nous enlever la contrainte d'avoir à choisir la version de ignition
etc ...

On va créer un premier fichier sous l'extension .bu, qui va rassembler
la configuration des Nodes Masters pour le démon Chrony :

``` code
╰─> cat 99-master-chrony-conf-override.bu 
variant: openshift
version: 4.12.0
metadata:
  name: 99-master-chrony-conf-override
  labels:
    machineconfiguration.openshift.io/role: master
storage:
  files:
    - path: /etc/chrony.conf
      mode: 0644
      overwrite: true
      contents:
        inline: |
          server ntp.abes.fr iburst
          driftfile /var/lib/chrony/drift
          makestep 1.0 3
          rtcsync
          logdir /var/log/chrony
          keyfile /etc/chrony.keys
```

idem pour les Workers :

``` code
╰─> cat 99-worker-chrony-conf-override.bu 
variant: openshift
version: 4.12.0
metadata:
  name: 99-worker-chrony-conf-override
  labels:
    machineconfiguration.openshift.io/role: worker
storage:
  files:
    - path: /etc/chrony.conf
      mode: 0644
      overwrite: true
      contents:
        inline: |
          server ntp.abes.fr iburst
          driftfile /var/lib/chrony/drift
          makestep 1.0 3
          rtcsync
          logdir /var/log/chrony
          keyfile /etc/chrony.keys
```

Ensuite nous allons générer les objets MachineConfig afin d'apliquer ses
configurations respectives à chaque node du cluster.

``` code
╰─> butane 99-master-chrony-conf-override.bu -o 99-master-chrony-conf-override.yaml
```

``` code
╰─> butane 99-worker-chrony-conf-override.bu -o 99-worker-chrony-conf-override.yaml
```

Butane va se charger tout seul de transformer les manifests en
MachineConfig de manière à matcher la dernière version de Ignition
utilisée par les nodes FCOS et de chiffrer la configuration en base64.

Exemple l'objet généré pour les Masters :

``` code
# Generated by Butane; do not edit
apiVersion: machineconfiguration.openshift.io/v1
kind: MachineConfig
metadata:
  labels:
    machineconfiguration.openshift.io/role: master
  name: 99-master-chrony-conf-override
spec:
  config:
    ignition:
      version: 3.2.0
    storage:
      files:
        - contents:
            compression: gzip
            source: data:;base64,H4sIAAAAAAAC/yzMwa0DIQyE4burcAXwnlIRsGZjQWA1dlai+0gJ1xl9vwluAQ+/QspioYI1v2FOB7R61S4c74TYNcfyxBwrfh96pSbmcvF/+OMHwYutUajP81BsM89tqMn6tcTL3kKTZfQJAAD//y8Bf5KBAAAA
          mode: 420
          overwrite: true
          path: /etc/chrony.conf
```

Il nous reste plus qu'à appliquer les objets MachineConfig au cluster
pour que celui-ci puisse se rafraîchir à la configuration qu'on aura
voulu lui apporter.

``` code
╰─> oc apply -f 99-master-chrony-conf-override.yaml
╰─> oc apply -f 99-worker-chrony-conf-override.yaml
```

Une fois appliquer il va falloir attendre que toutes les machines du
cluster redémarrent pour pouvoir appliquer la nouvelle configuration
Chrony.

``` code
╰─> oc describe machineconfigpools.machineconfiguration.openshift.io

Name:         master
Namespace:    
Labels:       machineconfiguration.openshift.io/mco-built-in=
              operator.machineconfiguration.openshift.io/required-for-upgrade=
              pools.operator.machineconfiguration.openshift.io/master=
Annotations:  <none>
API Version:  machineconfiguration.openshift.io/v1
Kind:         MachineConfigPool
Degraded Machine Count:     0
  Machine Count:              3
  Observed Generation:        3
  Ready Machine Count:        3
  Unavailable Machine Count:  0
  Updated Machine Count:      3
Events:
  Type    Reason                   Age   From                                      Message
  ----    ------                   ----  ----                                      -------
  Normal  RenderedConfigGenerated  70m   machineconfigcontroller-rendercontroller  rendered-master-ac69e7d7738d5f3c3f1761e13a7c2325 successfully generated (release version: 4.12.0-0.okd-2023-02-18-033438, controller version: 4099f3c4f4ea9df85a7516a6300a4c6e5504a5cd)
  Normal  SetDesiredConfig         69m   machineconfigcontroller-nodecontroller    Targeted node orchidee-hw8b4-master-1 to config rendered-master-ac69e7d7738d5f3c3f1761e13a7c2325
  Normal  AnnotationChange         69m   machineconfigcontroller-nodecontroller    Node orchidee-hw8b4-master-1 now has machineconfiguration.openshift.io/desiredConfig=rendered-master-ac69e7d7738d5f3c3f1761e13a7c2325
  Normal  AnnotationChange         69m   machineconfigcontroller-nodecontroller    Node orchidee-hw8b4-master-1 now has machineconfiguration.openshift.io/state=Working
  Normal  SetDesiredConfig         63m   machineconfigcontroller-nodecontroller    Targeted node orchidee-hw8b4-master-2 to config rendered-master-ac69e7d7738d5f3c3f1761e13a7c2325
  Normal  AnnotationChange         63m   machineconfigcontroller-nodecontroller    Node orchidee-hw8b4-master-2 now has machineconfiguration.openshift.io/desiredConfig=rendered-master-ac69e7d7738d5f3c3f1761e13a7c2325
  Normal  AnnotationChange         63m   machineconfigcontroller-nodecontroller    Node orchidee-hw8b4-master-2 now has machineconfiguration.openshift.io/state=Working
  Normal  SetDesiredConfig         56m   machineconfigcontroller-nodecontroller    Targeted node orchidee-hw8b4-master-0 to config rendered-master-ac69e7d7738d5f3c3f1761e13a7c2325
  Normal  AnnotationChange         56m   machineconfigcontroller-nodecontroller    Node orchidee-hw8b4-master-0 now has machineconfiguration.openshift.io/desiredConfig=rendered-master-ac69e7d7738d5f3c3f1761e13a7c2325
  Normal  AnnotationChange         56m   machineconfigcontroller-nodecontroller    Node orchidee-hw8b4-master-0 now has machineconfiguration.openshift.io/state=Working

Name:         worker
Namespace:    
Labels:       machineconfiguration.openshift.io/mco-built-in=
              pools.operator.machineconfiguration.openshift.io/worker=
Annotations:  <none>
API Version:  machineconfiguration.openshift.io/v1
Kind:         MachineConfigPool
Degraded Machine Count:     0
  Machine Count:              3
  Observed Generation:        3
  Ready Machine Count:        3
  Unavailable Machine Count:  0
  Updated Machine Count:      3
Events:
  Type    Reason                   Age   From                                      Message
  ----    ------                   ----  ----                                      -------
  Normal  RenderedConfigGenerated  69m   machineconfigcontroller-rendercontroller  rendered-worker-2dbc01a01c8c8224b9ef5e7b8e5034b0 successfully generated (release version: 4.12.0-0.okd-2023-02-18-033438, controller version: 4099f3c4f4ea9df85a7516a6300a4c6e5504a5cd)
  Normal  SetDesiredConfig         69m   machineconfigcontroller-nodecontroller    Targeted node orchidee-hw8b4-worker-nvcjf to config rendered-worker-2dbc01a01c8c8224b9ef5e7b8e5034b0
  Normal  SetDesiredConfig         64m   machineconfigcontroller-nodecontroller    Targeted node orchidee-hw8b4-worker-png59 to config rendered-worker-2dbc01a01c8c8224b9ef5e7b8e5034b0
  Normal  SetDesiredConfig         59m   machineconfigcontroller-nodecontroller    Targeted node orchidee-hw8b4-worker-mwr49 to config rendered-worker-2dbc01a01c8c8224b9ef5e7b8e5034b0
```

En faisant une description d'état sur la ressouce MachineConfigPool,
nous pouvons voir où en est la progression du rendu de la nouvelle
configuration qu'on a apporté à nos Masters et Workers.

Il nous reste plus qu'à vérifer le bon déploiement de la nouvelle
configuration et à changer de timezone.

``` code
╰─> for node in $(oc get nodes | tail -n +2 | awk '{print $1}');  
do cat <<EOF | oc debug node/$node  
chroot /host  
timedatectl  
EOF
done

Starting pod/orchidee-hw8b4-master-0-debug ...
To use host binaries, run `chroot /host`
Pod IP: 10.35.202.154
If you don\'t see a command prompt, try pressing enter.
sh: cannot set terminal process group (65521): Inappropriate ioctl for device
sh: no job control in this shell
sh-5.2# timedatectl 
sh-5.2# exit
               Local time: Mon 2023-06-12 12:25:51 CEST
           Universal time: Mon 2023-06-12 10:25:51 UTC
                 RTC time: Mon 2023-06-12 10:25:51
                Time zone: Europe/Paris (CEST, +0200)
System clock synchronized: yes
              NTP service: active
          RTC in local TZ: no
Removing debug pod ...
Temporary namespace openshift-debug-fh9rk was removed.
Temporary namespace openshift-debug-nmp2q is created for debugging node...

Starting pod/orchidee-hw8b4-master-1-debug ...
To use host binaries, run `chroot /host`
Pod IP: 10.35.202.52
If you don\'t see a command prompt, try pressing enter.
sh: cannot set terminal process group (126312): Inappropriate ioctl for device
sh: no job control in this shell
sh-5.2# timedatectl 
               Local time: Mon 2023-06-12 12:25:54 CEST
           Universal time: Mon 2023-06-12 10:25:54 UTC
                 RTC time: Mon 2023-06-12 10:25:54
                Time zone: Europe/Paris (CEST, +0200)
System clock synchronized: yes
              NTP service: active
          RTC in local TZ: no
sh-5.2# exit
b0
Removing debug pod ...
Temporary namespace openshift-debug-nmp2q was removed.
Temporary namespace openshift-debug-mwwsk is created for debugging node...

Starting pod/orchidee-hw8b4-master-2-debug ...
To use host binaries, run `chroot /host`
Pod IP: 10.35.202.53
If you don\'t see a command prompt, try pressing enter.
sh: cannot set terminal process group (87465): Inappropriate ioctl for device
sh: no job control in this shell
sh-5.2# timedatectl 
sh-5.2# exit
               Local time: Mon 2023-06-12 12:25:58 CEST
           Universal time: Mon 2023-06-12 10:25:58 UTC
                 RTC time: Mon 2023-06-12 10:25:58
                Time zone: Europe/Paris (CEST, +0200)
System clock synchronized: yes
              NTP service: active
          RTC in local TZ: no
    API Version:  machineconfiguration.openshift.io/v1
Removing debug pod ...
Temporary namespace openshift-debug-mwwsk was removed.
Temporary namespace openshift-debug-w6wwz is created for debugging node...

Starting pod/orchidee-hw8b4-worker-mwr49-debug ...
To use host binaries, run `chroot /host`
Pod IP: 10.35.202.158
If you don\'t see a command prompt, try pressing enter.
sh: cannot set terminal process group (48883): Inappropriate ioctl for device
sh: no job control in this shell
sh-5.2# timedatectl 
               Local time: Mon 2023-06-12 12:26:00 CEST
           Universal time: Mon 2023-06-12 10:26:00 UTC
                 RTC time: Mon 2023-06-12 10:26:00
                Time zone: Europe/Paris (CEST, +0200)
System clock synchronized: yes
              NTP service: active
          RTC in local TZ: no
sh-5.2# exit

Removing debug pod ...
Temporary namespace openshift-debug-w6wwz was removed.
Temporary namespace openshift-debug-mz2dj is created for debugging node...

Starting pod/orchidee-hw8b4-worker-nvcjf-debug ...
To use host binaries, run `chroot /host`
Pod IP: 10.35.202.157
If you don\'t see a command prompt, try pressing enter.
sh: cannot set terminal process group (82781): Inappropriate ioctl for device
sh: no job control in this shell
sh-5.2# timedatectl 
sh-5.2# exit
               Local time: Mon 2023-06-12 12:26:03 CEST
           Universal time: Mon 2023-06-12 10:26:03 UTC
                 RTC time: Mon 2023-06-12 10:26:03
                Time zone: Europe/Paris (CEST, +0200)
System clock synchronized: yes
              NTP service: active
          RTC in local TZ: no

Removing debug pod ...
Temporary namespace openshift-debug-mz2dj was removed.
Temporary namespace openshift-debug-f99cd is created for debugging node...

Starting pod/orchidee-hw8b4-worker-png59-debug ...
To use host binaries, run `chroot /host`
Pod IP: 10.35.202.156
If you don't see a command prompt, try pressing enter.
sh: cannot set terminal process group (74256): Inappropriate ioctl for device
sh: no job control in this shell
sh-5.2# timedatectl 
               Local time: Mon 2023-06-12 12:26:05 CEST
           Universal time: Mon 2023-06-12 10:26:05 UTC
                 RTC time: Mon 2023-06-12 10:26:05
                Time zone: Europe/Paris (CEST, +0200)
System clock synchronized: yes
              NTP service: active
          RTC in local TZ: no
sh-5.2# exit

Removing debug pod ...
Temporary namespace openshift-debug-f99cd was removed.
```

Pour mettre en place la timezone :

``` code
╰─> for node in $(oc get nodes | tail -n +2 | awk '{print $1}');  
do cat <<EOF | oc debug node/$node  
chroot /host  
sudo timedatectl set-timezone Europe/Paris  
EOF
done

Temporary namespace openshift-debug-7llhc is created for debugging node...
Starting pod/orchidee-hw8b4-master-0-debug ...
To use host binaries, run `chroot /host`
Pod IP: 10.35.202.154
If you don\'t see a command prompt, try pressing enter.
sh: cannot set terminal process group (45226): Inappropriate ioctl for device
sh: no job control in this shell
sh-5.2# sudo timedatectl set-timezone Europe/Paris
sh-5.2# exit

Removing debug pod ...
Temporary namespace openshift-debug-7llhc was removed.
Temporary namespace openshift-debug-8cwbt is created for debugging node...
Starting pod/orchidee-hw8b4-master-1-debug ...
To use host binaries, run `chroot /host`
Pod IP: 10.35.202.52
If you don\'t see a command prompt, try pressing enter.
sh: cannot set terminal process group (96470): Inappropriate ioctl for device
sh: no job control in this shell
sh-5.2# sudo timedatectl set-timezone Europe/Paris
sh-5.2# exit

Removing debug pod ...
Temporary namespace openshift-debug-8cwbt was removed.
Temporary namespace openshift-debug-pmv6x is created for debugging node...
Starting pod/orchidee-hw8b4-master-2-debug ...
To use host binaries, run `chroot /host`
Pod IP: 10.35.202.53
If you don\'t see a command prompt, try pressing enter.
sh: cannot set terminal process group (63372): Inappropriate ioctl for device
sh: no job control in this shell
sh-5.2# sudo timedatectl set-timezone Europe/Paris
sh-5.2# exit

Removing debug pod ...
Temporary namespace openshift-debug-pmv6x was removed.
Temporary namespace openshift-debug-rvg7n is created for debugging node...
Starting pod/orchidee-hw8b4-worker-mwr49-debug ...
To use host binaries, run `chroot /host`
Pod IP: 10.35.202.158
If you don\'t see a command prompt, try pressing enter.
sh: cannot set terminal process group (35037): Inappropriate ioctl for device
sh: no job control in this shell
sh-5.2# sudo timedatectl set-timezone Europe/Paris
sh-5.2# exit

Removing debug pod ...
Temporary namespace openshift-debug-rvg7n was removed.
Temporary namespace openshift-debug-hbc9v is created for debugging node...
Starting pod/orchidee-hw8b4-worker-nvcjf-debug ...
To use host binaries, run `chroot /host`
Pod IP: 10.35.202.157
If you don\'t see a command prompt, try pressing enter.
sh: cannot set terminal process group (64064): Inappropriate ioctl for device
sh: no job control in this shell
sh-5.2# sudo timedatectl set-timezone Europe/Paris
sh-5.2# exit

Removing debug pod ...
Temporary namespace openshift-debug-hbc9v was removed.
Temporary namespace openshift-debug-cj9mc is created for debugging node...
Starting pod/orchidee-hw8b4-worker-png59-debug ...
To use host binaries, run `chroot /host`
Pod IP: 10.35.202.156
If you don't see a command prompt, try pressing enter.
sh: cannot set terminal process group (55575): Inappropriate ioctl for device
sh: no job control in this shell
sh-5.2# sudo timedatectl set-timezone Europe/Paris
sh-5.2# exit

Removing debug pod ...
Temporary namespace openshift-debug-cj9mc was removed.
```
